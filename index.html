<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Rekod Kehadiran Murid SKSA Tahap 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;}
    body{margin:0;padding:0;background:#f3f4f6;color:#111827;}
    header{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;padding:12px 20px 14px;box-shadow:0 2px 8px rgba(15,23,42,.4);position:sticky;top:0;z-index:10;}
    .header-main{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
    .header-logo{height:48px;width:48px;border-radius:999px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,.25);}
    .header-logo img{max-width:100%;max-height:100%;display:block;}
    .header-text h1{margin:0;font-size:1.4rem;font-weight:700;}
    .header-text p{margin:2px 0 0;font-size:.9rem;opacity:.9;}
    main{max-width:1040px;margin:20px auto;padding:0 16px 32px;}
    .card{background:#fff;border-radius:16px;box-shadow:0 10px 25px rgba(15,23,42,.08);padding:20px;margin-bottom:20px;border:1px solid #e5e7eb;}
    .card-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;}
    .card-header h2{margin:0;font-size:1.1rem;display:flex;align-items:center;gap:8px;}
    .badge{display:inline-block;padding:2px 10px;border-radius:999px;font-size:.75rem;background:#e0f2fe;color:#0369a1;font-weight:600;}
    .date-display{font-size:.9rem;color:#4b5563;}
    label{font-size:.9rem;color:#374151;}
    select,button{font-size:.9rem;}
    select{width:100%;padding:8px 10px;border-radius:999px;border:1px solid #d1d5db;outline:none;background:#f9fafb;transition:border-color .15s,box-shadow .15s,background .15s;}
    select:focus{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.25);background:#fff;}
    .flex-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;}
    .btn{border-radius:999px;border:none;padding:8px 16px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:6px;box-shadow:0 8px 16px rgba(15,23,42,.18);transition:transform .1s,box-shadow .1s,background .1s;}
    .btn-primary{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;}
    .btn-outline{background:#fff;color:#1f2937;border:1px solid #d1d5db;box-shadow:none;}
    .btn:hover{transform:translateY(-1px);box-shadow:0 12px 22px rgba(15,23,42,.18);}
    .btn:active{transform:translateY(0);box-shadow:0 6px 12px rgba(15,23,42,.18);}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#f3f4f6;font-size:.8rem;color:#374151;}
    .pill strong{color:#111827;}
    .tabs{margin-top:4px;display:flex;flex-wrap:wrap;gap:6px;border-bottom:1px solid #e5e7eb;padding-bottom:4px;}
    .tab-btn{border:1px solid #e5e7eb;background:#f9fafb;padding:6px 14px;border-radius:999px;cursor:pointer;font-size:.9rem;color:#4b5563;transition:background .15s,color .15s,box-shadow .15s,border-color .15s;}
    .tab-btn:hover{background:#f3f4ff;}
    .tab-btn.active{background:#fff;color:#1d4ed8;font-weight:600;border-color:#bfdbfe;box-shadow:0 2px 6px rgba(15,23,42,.2);}
    .tab-panel{margin-top:12px;}
    .subtabs{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;}
    .subtab-btn{border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;padding:4px 12px;font-size:.85rem;cursor:pointer;color:#4b5563;transition:background .15s,color .15s,box-shadow .15s,border-color .15s;}
    .subtab-btn:hover{background:#eef2ff;}
    .subtab-btn.active{background:#fff;color:#2563eb;font-weight:600;border-color:#bfdbfe;box-shadow:0 1px 4px rgba(15,23,42,.2);}
    .subtab-panel{margin-top:8px;}
    .search-row{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;}
    .search-row label{font-size:.85rem;white-space:nowrap;}
    .search-row input[type=text]{flex:1 1 220px;padding:8px 10px;border-radius:999px;border:1px solid #d1d5db;background:#f9fafb;font-size:.9rem;outline:none;transition:border-color .15s,box-shadow .15s,background .15s;}
    .search-row input[type=text]:focus{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.25);background:#fff;}
    .students-container{margin-top:12px;max-height:420px;overflow-y:auto;border-radius:12px;border:1px solid #e5e7eb;background:#f9fafb;}
    .students-header{display:grid;grid-template-columns:52px 1fr 90px;padding:8px 12px;border-bottom:1px solid #e5e7eb;font-size:.8rem;font-weight:600;color:#6b7280;background:#f3f4f6;position:sticky;top:0;z-index:2;}
    .student-row{display:grid;grid-template-columns:52px 1fr 90px;padding:7px 12px;align-items:center;font-size:.9rem;border-bottom:1px solid #e5e7eb;background:#fff;}
    .student-row:nth-child(even){background:#f9fafb;}
    .student-row:hover{background:#eff6ff;}
    .student-name{font-weight:500;color:#111827;}
    .checkbox-wrapper{display:flex;justify-content:center;}
    .checkbox-wrapper input{width:18px;height:18px;cursor:pointer;}
    .summary-box{margin-top:16px;padding:12px 14px;border-radius:12px;background:#eff6ff;border:1px solid #bfdbfe;font-size:.9rem;color:#1e3a8a;}
    .summary-main{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;}
    .summary-main strong{font-size:1rem;}
    .summary-absent{margin-top:8px;font-size:.9rem;}
    .summary-absent ul{margin:4px 0 0 18px;padding:0;}
    .summary-absent li{margin:0;}
    .status-bar{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;font-size:.85rem;}
    .status-pill{padding:4px 10px;border-radius:999px;background:#e5f9ed;color:#047857;font-weight:600;}
    .status-pill.error{background:#fee2e2;color:#b91c1c;}
    .status-pill.info{background:#e0f2fe;color:#0369a1;}
    .summary-header-row{font-size:.95rem;margin-top:4px;}
    .summary-date-link{color:#2563eb;text-decoration:underline;}
    .summary-table-wrapper{margin-top:10px;overflow-x:auto;border-radius:8px;border:1px solid #cbd5e1;background:#f9fafb;}
    .summary-table{width:100%;border-collapse:collapse;font-size:.9rem;background:#fff;}
    .summary-table th,.summary-table td{border:1px solid #cbd5e1;padding:6px 8px;text-align:left;}
    .summary-table th{background:#e5f0ff;color:#1f2937;font-weight:600;}
    .summary-table td.main-row-cell{background:#fff;}
    .summary-table tr:nth-child(even) td.main-row-cell{background:#f9fafb;}
    .row-not-updated td.main-row-cell{background:#fff7ed;}
    .cell-not-updated{font-weight:600;color:#b45309;}
    .attendance-link{cursor:pointer;text-decoration:underline;color:#111827;}
    .attendance-link:hover{color:#1d4ed8;}
    .absent-row td{background:#fefce8;font-size:.85rem;}
    .summary-footer{margin-top:8px;font-size:.85rem;color:#374151;}
    .darjah-col{width:70px;text-align:center;white-space:nowrap;}
    footer{text-align:center;font-size:.75rem;color:#9ca3af;margin-top:10px;}
    @media(max-width:640px){
      .header-text h1{font-size:1.15rem;}
      .students-header,.student-row{grid-template-columns:42px 1fr 80px;}
      .students-container{max-height:360px;}
    }
  </style>
</head>
<body>
<header>
  <div class="header-main">
    <div class="header-logo">
      <img src="https://i.imgur.com/AfsVtVG.png" alt="Logo SKSA"/>
    </div>
    <div class="header-text">
      <h1>Rekod Kehadiran Harian Murid SKSA (Tahap 1)</h1>
      <p>Guru hanya perlu tandakan murid <strong>tidak hadir</strong>. Sistem akan kira kehadiran automatik untuk hari tersebut.</p>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="card-header">
      <h2>üìö Rekod Kehadiran <span class="badge">Tahap 1 (2025)</span></h2>
      <div class="date-display" id="todayDisplay">Tarikh:</div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="byClass">Rekod Mengikut Kelas</button>
      <button class="tab-btn" data-tab="summary">Ringkasan Semua Kelas</button>
    </div>

    <!-- TAB: Mengikut kelas -->
    <div id="tab-byClass" class="tab-panel" style="display:block;">
      <div>
        <label for="classSelect">Pilih kelas:</label>
        <select id="classSelect">
          <option value="">‚Äî Sila pilih kelas ‚Äî</option>
        </select>
      </div>

      <div class="flex-row">
        <div class="pill">üîÅ <strong>Setiap hari baharu</strong> ‚Äì kehadiran bermula semula (semua murid dianggap hadir).</div>
        <div>
          <button type="button" class="btn btn-outline" id="btnAllPresent">‚úÖ Semua hadir</button>
          <button type="button" class="btn btn-outline" id="btnClearTicks">‚úñ Reset tanda</button>
        </div>
      </div>

      <div id="studentsSection" style="margin-top:16px;display:none;">
        <div class="search-row">
          <label for="searchInput">Carian nama murid:</label>
          <input id="searchInput" type="text" placeholder='Taip nama atau sebahagian nama, contoh: "adra"'/>
        </div>

        <div class="students-container">
          <div class="students-header">
            <div>No.</div><div>Nama Murid</div><div style="text-align:center;">Tidak hadir</div>
          </div>
          <div id="studentsList"></div>
        </div>

        <div class="flex-row">
          <div class="pill" id="countInfo">üë• Jumlah murid: <strong>0</strong></div>
          <button type="button" class="btn btn-primary" id="btnSave">üíæ Simpan kehadiran hari ini</button>
        </div>

        <div class="summary-box" id="summaryBox" style="display:none;">
          <div class="summary-main">
            <div>
              <strong id="summaryTitle">Kehadiran hari ini:</strong>
              <div id="summaryRatio">0/0 hadir</div>
            </div>
            <div id="summaryMini"></div>
          </div>
          <div class="summary-absent" id="summaryAbsent"></div>
        </div>

        <div class="status-bar" id="statusBar"></div>
      </div>
    </div>

    <!-- TAB: Ringkasan semua kelas -->
    <div id="tab-summary" class="tab-panel" style="display:none;">

      <div class="subtabs">
        <button class="subtab-btn active" data-subtab="daily">Harian</button>
        <button class="subtab-btn" data-subtab="weekly">Mingguan</button>
        <button class="subtab-btn" data-subtab="monthly">Bulanan</button>
      </div>

      <!-- HARIAN -->
      <div id="summaryDailyPanel" class="subtab-panel" style="display:block;">
        <div class="summary-header-row">
          Rekod Kehadiran Pada <span id="summaryDateLink" class="summary-date-link"></span>
        </div>
        <div class="summary-table-wrapper">
          <table class="summary-table">
            <thead>
              <tr>
                <th>Bil</th>
                <th class="darjah-col">Darjah</th>
                <th>Kelas</th>
                <th>Kehadiran</th>
              </tr>
            </thead>
            <tbody id="summaryTableBody"></tbody>
          </table>
        </div>
        <div class="summary-footer" id="summaryFooter">
          Kehadiran : Tiada rekod kehadiran<br/>Peratus Kehadiran : Tiada rekod kehadiran
        </div>
      </div>

      <!-- MINGGUAN -->
      <div id="summaryWeeklyPanel" class="subtab-panel" style="display:none;">
        <div class="summary-header-row">
          Ringkasan Mingguan: <span id="weeklyRangeLabel"></span>
        </div>
        <div class="summary-table-wrapper">
          <table class="summary-table">
            <thead>
              <tr>
                <th rowspan="2">Bil</th>
                <th rowspan="2" class="darjah-col">Darjah</th>
                <th rowspan="2">Kelas</th>
                <th colspan="5" id="weeklyHeaderSpan">Kehadiran</th>
              </tr>
              <tr id="weeklyDateRow"></tr>
            </thead>
            <tbody id="weeklyTableBody"></tbody>
          </table>
        </div>
        <div class="summary-footer" id="weeklyInfo">
          Tiada rekod kehadiran untuk minggu ini.
        </div>
      </div>

      <!-- BULANAN -->
      <div id="summaryMonthlyPanel" class="subtab-panel" style="display:none;">
        <div class="summary-header-row" style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
          <span>Ringkasan Bulanan: <span id="monthlyLabel"></span></span>
          <button type="button" class="btn btn-outline" id="btnPrintMonthly">üñ® Cetak</button>
        </div>
        <div class="summary-table-wrapper">
          <table class="summary-table">
            <thead>
              <tr>
                <th rowspan="2">Bil</th>
                <th rowspan="2" class="darjah-col">Darjah</th>
                <th rowspan="2">Kelas</th>
                <th colspan="31" id="monthlyHeaderSpan">Kehadiran</th>
              </tr>
              <tr id="monthlyDateRow"></tr>
            </thead>
            <tbody id="monthlyTableBody"></tbody>
          </table>
        </div>
        <div class="summary-footer" id="monthlyInfo">
          Tiada rekod kehadiran untuk bulan ini.
        </div>
      </div>

    </div>
  </section>

  <footer>SK Sri Aman ¬∑ Modul Kehadiran Harian Tahap 1 (Firebase Realtime Database)</footer>
</main>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="database.js"></script>

<script>
(function(){
  'use strict';

  // Guna firebaseConfig dari database.js
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const MONTH_NAMES_MS=["Januari","Februari","Mac","April","Mei","Jun","Julai","Ogos","September","Oktober","November","Disember"];

  function formatDateKey(date){
    const y=date.getFullYear(),m=String(date.getMonth()+1).padStart(2,'0'),d=String(date.getDate()).padStart(2,'0');
    return y+"-"+m+"-"+d;
  }
  function formatHumanDate(date){
    const d=String(date.getDate()).padStart(2,'0'),mIdx=date.getMonth(),y=date.getFullYear();
    return d+" "+MONTH_NAMES_MS[mIdx]+" "+y;
  }
  function formatShortDM(date){
    const d=String(date.getDate()).padStart(2,'0'),m=String(date.getMonth()+1).padStart(2,'0');
    return d+"/"+m;
  }
  function dateFromKey(key){
    const y=parseInt(key.slice(0,4),10);
    const m=parseInt(key.slice(5,7),10)-1;
    const d=parseInt(key.slice(8,10),10);
    return new Date(y,m,d);
  }

  const today=new Date();
  const todayKey=formatDateKey(today);
  const todayHuman=formatHumanDate(today);

  // DOM
  const todayDisplay=document.getElementById('todayDisplay');
  const summaryDateLink=document.getElementById('summaryDateLink');

  const classSelect=document.getElementById('classSelect');
  const studentsSection=document.getElementById('studentsSection');
  const studentsList=document.getElementById('studentsList');
  const countInfo=document.getElementById('countInfo');
  const btnSave=document.getElementById('btnSave');
  const btnAllPresent=document.getElementById('btnAllPresent');
  const btnClearTicks=document.getElementById('btnClearTicks');
  const summaryBox=document.getElementById('summaryBox');
  const summaryTitle=document.getElementById('summaryTitle');
  const summaryRatio=document.getElementById('summaryRatio');
  const summaryMini=document.getElementById('summaryMini');
  const summaryAbsent=document.getElementById('summaryAbsent');
  const statusBar=document.getElementById('statusBar');
  const searchInput=document.getElementById('searchInput');

  const summaryTableBody=document.getElementById('summaryTableBody');
  const summaryFooter=document.getElementById('summaryFooter');

  const weeklyRangeLabel=document.getElementById('weeklyRangeLabel');
  const weeklyHeaderSpan=document.getElementById('weeklyHeaderSpan');
  const weeklyDateRow=document.getElementById('weeklyDateRow');
  const weeklyTableBody=document.getElementById('weeklyTableBody');
  const weeklyInfo=document.getElementById('weeklyInfo');

  const monthlyLabel=document.getElementById('monthlyLabel');
  const monthlyHeaderSpan=document.getElementById('monthlyHeaderSpan');
  const monthlyDateRow=document.getElementById('monthlyDateRow');
  const monthlyTableBody=document.getElementById('monthlyTableBody');
  const monthlyInfo=document.getElementById('monthlyInfo');
  const btnPrintMonthly=document.getElementById('btnPrintMonthly');

  todayDisplay.textContent="Tarikh: "+todayHuman;
  summaryDateLink.textContent=todayHuman;

  function setStatus(msg,type){
    statusBar.innerHTML='';
    if(!msg)return;
    const span=document.createElement('span');
    span.className='status-pill'+(type?' '+type:'');
    span.textContent=msg;
    statusBar.appendChild(span);
  }
  function clearStatus(){statusBar.innerHTML='';}

  // Tab utama
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab=btn.dataset.tab;
      document.getElementById('tab-byClass').style.display=tab==='byClass'?'block':'none';
      document.getElementById('tab-summary').style.display=tab==='summary'?'block':'none';
    });
  });

  // Subtab
  document.querySelectorAll('.subtab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.subtab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const sub=btn.dataset.subtab;
      document.getElementById('summaryDailyPanel').style.display=sub==='daily'?'block':'none';
      document.getElementById('summaryWeeklyPanel').style.display=sub==='weekly'?'block':'none';
      document.getElementById('summaryMonthlyPanel').style.display=sub==='monthly'?'block':'none';
    });
  });

  btnPrintMonthly.addEventListener('click',()=>window.print());

  function populateClassDropdown(){
    summaryConfig.forEach(item=>{
      const opt=document.createElement('option');
      opt.value=item.code;
      opt.textContent=item.code+" - "+item.kelasLabel;
      classSelect.appendChild(opt);
    });
  }

  function renderStudentsForClass(kelas){
    studentsList.innerHTML='';
    summaryBox.style.display='none';
    clearStatus();
    const names=classData[kelas]||[];
    if(!names.length){
      studentsSection.style.display='none';
      setStatus('Tiada senarai murid untuk kelas ini.','error');
      return;
    }
    studentsSection.style.display='block';
    names.forEach((nama,idx)=>{
      const row=document.createElement('div');
      row.className='student-row';
      row.dataset.name=(nama||'').toLowerCase();
      const c1=document.createElement('div');c1.textContent=idx+1;
      const c2=document.createElement('div');c2.className='student-name';c2.textContent=nama;
      const c3=document.createElement('div');c3.className='checkbox-wrapper';
      const chk=document.createElement('input');chk.type='checkbox';chk.dataset.nama=nama;
      c3.appendChild(chk);
      row.appendChild(c1);row.appendChild(c2);row.appendChild(c3);
      studentsList.appendChild(row);
    });
    countInfo.innerHTML="üë• Jumlah murid: <strong>"+names.length+"</strong>";
    searchInput.value='';
  }

  function getAbsentNames(){
    const arr=[];
    studentsList.querySelectorAll('input[type=checkbox]').forEach(chk=>{
      if(chk.checked)arr.push(chk.dataset.nama);
    });
    return arr;
  }

  function updateSummaryBox(kelas,absent){
    const total=(classData[kelas]||[]).length;
    const absentCount=absent.length;
    const present=total-absentCount;
    summaryTitle.textContent="Kehadiran hari ini ("+kelas+"):";
    summaryRatio.textContent=present+"/"+total+" hadir";
    summaryMini.textContent="Tidak hadir: "+absentCount+" orang";

    if(absentCount>0){
      const ul=document.createElement('ul');
      absent.forEach(n=>{const li=document.createElement('li');li.textContent=n;ul.appendChild(li);});
      summaryAbsent.innerHTML="Senarai murid tidak hadir:";summaryAbsent.appendChild(ul);
    }else{
      summaryAbsent.textContent="Semua murid hadir.";
    }
    summaryBox.style.display='block';
  }

  function applySearchFilter(){
    const q=searchInput.value.trim().toLowerCase();
    studentsList.querySelectorAll('.student-row').forEach(row=>{
      const name=row.dataset.name||'';
      row.style.display=!q||name.includes(q)?'':'none';
    });
  }
  searchInput.addEventListener('input',applySearchFilter);

  function saveAttendance(){
    const kelas=classSelect.value;
    if(!kelas){setStatus('Sila pilih kelas dahulu.','error');return;}
    const names=classData[kelas]||[];
    if(!names.length){setStatus('Tiada senarai murid untuk kelas ini.','error');return;}
    const absentNames=getAbsentNames();
    const total=names.length;
    const present=total-absentNames.length;
    const meta=summaryConfig.find(x=>x.code===kelas)||{};
    const data={
      kodKelas:kelas,
      darjah:meta.darjah||'',
      kelasLabel:meta.kelasLabel||'',
      total,
      present,
      absentCount:absentNames.length,
      absentNames,
      dateKey:todayKey,
      dateHuman:todayHuman,
      updatedAt:Date.now()
    };
    const path=`kehadiran/${todayKey}/${kelas}`;
    setStatus('Menyimpan kehadiran...','info');
    db.ref(path).set(data).then(()=>{
      setStatus('Kehadiran berjaya disimpan.','');
      updateSummaryBox(kelas,absentNames);
      loadDailySummary();
      loadWeeklySummary();
      loadMonthlySummary();
    }).catch(err=>{
      console.error(err);
      setStatus('Ralat semasa menyimpan kehadiran: '+err.message,'error');
    });
  }

  function loadExistingAttendance(kelas){
    const path=`kehadiran/${todayKey}/${kelas}`;
    db.ref(path).once('value').then(snap=>{
      const data=snap.val();
      studentsList.querySelectorAll('input[type=checkbox]').forEach(chk=>chk.checked=false);
      if(data&&Array.isArray(data.absentNames)){
        studentsList.querySelectorAll('input[type=checkbox]').forEach(chk=>{
          if(data.absentNames.includes(chk.dataset.nama))chk.checked=true;
        });
        updateSummaryBox(kelas,data.absentNames);
      }else{
        summaryBox.style.display='none';
      }
    }).catch(err=>{
      console.error(err);
      setStatus('Gagal memuatkan rekod sedia ada: '+err.message,'error');
    });
  }

  // RINGKASAN HARIAN
  function loadDailySummary(){
    const path=`kehadiran/${todayKey}`;
    db.ref(path).once('value').then(snap=>{
      const all=snap.val()||{};
      summaryTableBody.innerHTML='';
      let totalPresent=0,totalStudents=0,bil=1;

      summaryConfig.forEach(cfg=>{
        const rec=all[cfg.code];
        const tr=document.createElement('tr');
        tr.className='main-row';

        const c1=document.createElement('td');c1.className='main-row-cell';c1.textContent=bil++;
        const c2=document.createElement('td');c2.className='main-row-cell darjah-col';c2.textContent=cfg.darjah;
        const c3=document.createElement('td');c3.className='main-row-cell';c3.textContent=cfg.kelasLabel;
        const c4=document.createElement('td');c4.className='main-row-cell';

        const detailRow=document.createElement('tr');
        detailRow.className='absent-row';
        detailRow.style.display='none';
        const detailTd=document.createElement('td');
        detailTd.colSpan=4;
        detailRow.appendChild(detailTd);

        if(rec){
          const ratio=(rec.present||0)+"/"+(rec.total||0);
          if(rec.absentCount>0 && Array.isArray(rec.absentNames) && rec.absentNames.length){
            const link=document.createElement('span');
            link.className='attendance-link';
            link.textContent=ratio;
            link.addEventListener('click',()=>{
              const content="Tidak hadir:<br>"+rec.absentNames.join("<br>");
              if(detailRow.style.display==='table-row'){
                detailRow.style.display='none';
              }else{
                detailTd.innerHTML=content;
                detailRow.style.display='table-row';
              }
            });
            c4.appendChild(link);
          }else{
            c4.textContent=ratio;
          }
          totalPresent+=rec.present||0;
          totalStudents+=rec.total||0;
          tr.appendChild(c1);tr.appendChild(c2);tr.appendChild(c3);tr.appendChild(c4);
          summaryTableBody.appendChild(tr);
          summaryTableBody.appendChild(detailRow);
        }else{
          tr.classList.add('row-not-updated');
          tr.appendChild(c1);tr.appendChild(c2);tr.appendChild(c3);
          const span=document.createElement('span');
          span.className='cell-not-updated';
          span.textContent='Kehadiran Belum Dikemaskini.';
          c4.appendChild(span);
          tr.appendChild(c4);
          summaryTableBody.appendChild(tr);
        }
      });

      if(totalStudents>0){
        const pct=(totalPresent/totalStudents)*100;
        summaryFooter.innerHTML=`Kehadiran : ${totalPresent}/${totalStudents}<br/>Peratus Kehadiran : ${pct.toFixed(1)}%`;
      }else{
        summaryFooter.innerHTML='Kehadiran : Tiada rekod kehadiran<br/>Peratus Kehadiran : Tiada rekod kehadiran';
      }
    }).catch(err=>{
      console.error(err);
      summaryFooter.innerHTML='Kehadiran : Ralat memuatkan data<br/>Peratus Kehadiran : Ralat memuatkan data';
    });
  }

  // RINGKASAN MINGGUAN
  function getWeekDates(baseDate){
    const d=new Date(baseDate.getFullYear(),baseDate.getMonth(),baseDate.getDate());
    const day=d.getDay(); // 0=Ahad
    const diffToMonday=(day+6)%7;
    const monday=new Date(d);monday.setDate(d.getDate()-diffToMonday);
    const arr=[];
    for(let i=0;i<5;i++){
      const tmp=new Date(monday);tmp.setDate(monday.getDate()+i);arr.push(tmp);
    }
    return arr;
  }

  function loadWeeklySummary(){
    const weekDates=getWeekDates(today);
    if(!weekDates.length)return;
    weeklyRangeLabel.textContent=formatShortDM(weekDates[0])+" - "+formatShortDM(weekDates[weekDates.length-1]);

    weeklyDateRow.innerHTML='';
    const dateKeys=[];
    weekDates.forEach(dt=>{
      const th=document.createElement('th');
      th.textContent=formatShortDM(dt);
      weeklyDateRow.appendChild(th);
      dateKeys.push(formatDateKey(dt));
    });
    weeklyHeaderSpan.colSpan=dateKeys.length;

    const promises=dateKeys.map(k=>db.ref('kehadiran/'+k).once('value'));
    Promise.all(promises).then(snaps=>{
      const allByDate={};
      snaps.forEach((snap,i)=>{allByDate[dateKeys[i]]=snap.val()||{};});

      weeklyTableBody.innerHTML='';
      let bil=1;

      summaryConfig.forEach(cfg=>{
        const tr=document.createElement('tr');
        const c1=document.createElement('td');c1.className='main-row-cell';c1.textContent=bil++;
        const c2=document.createElement('td');c2.className='main-row-cell darjah-col';c2.textContent=cfg.darjah;
        const c3=document.createElement('td');c3.className='main-row-cell';c3.textContent=cfg.kelasLabel;
        tr.appendChild(c1);tr.appendChild(c2);tr.appendChild(c3);

        const detailRow=document.createElement('tr');
        detailRow.className='absent-row';
        detailRow.style.display='none';
        const detailTd=document.createElement('td');
        detailTd.colSpan=3+dateKeys.length;
        detailRow.appendChild(detailTd);

        dateKeys.forEach(k=>{
          const rec=(allByDate[k]||{})[cfg.code];
          const td=document.createElement('td');td.className='main-row-cell';
          if(rec){
            const ratio=(rec.present||0)+"/"+(rec.total||0);
            if(rec.absentCount>0 && Array.isArray(rec.absentNames) && rec.absentNames.length){
              const link=document.createElement('span');
              link.className='attendance-link';
              link.textContent=ratio;
              link.addEventListener('click',()=>{
                const human=formatHumanDate(dateFromKey(k));
                const html="Tarikh "+human+"<br>Tidak hadir:<br>"+rec.absentNames.join("<br>");
                if(detailRow.style.display==='table-row' && detailRow.dataset.currentDate===k){
                  detailRow.style.display='none';
                }else{
                  detailRow.dataset.currentDate=k;
                  detailTd.innerHTML=html;
                  detailRow.style.display='table-row';
                }
              });
              td.appendChild(link);
            }else{
              td.textContent=ratio;
            }
          }else{
            td.textContent='-';
            td.style.color='#9ca3af';
          }
          tr.appendChild(td);
        });

        weeklyTableBody.appendChild(tr);
        weeklyTableBody.appendChild(detailRow);
      });

      weeklyInfo.textContent='Data minggu '+weeklyRangeLabel.textContent+'. "-" bermaksud tiada rekod kehadiran pada hari tersebut.';
    }).catch(err=>{
      console.error(err);
      weeklyInfo.textContent='Ralat memuatkan data mingguan: '+err.message;
    });
  }

  // RINGKASAN BULANAN
  function getMonthDates(baseDate){
    const y=baseDate.getFullYear(),m=baseDate.getMonth();
    const daysInMonth=new Date(y,m+1,0).getDate();
    const arr=[];
    for(let d=1;d<=daysInMonth;d++){arr.push(new Date(y,m,d));}
    return arr;
  }

  function loadMonthlySummary(){
    const monthDates=getMonthDates(today);
    if(!monthDates.length)return;
    const y=today.getFullYear(),mIdx=today.getMonth();
    monthlyLabel.textContent=MONTH_NAMES_MS[mIdx]+" "+y;

    monthlyDateRow.innerHTML='';
    const dateKeys=[];
    monthDates.forEach(dt=>{
      const th=document.createElement('th');
      th.textContent=String(dt.getDate());
      monthlyDateRow.appendChild(th);
      dateKeys.push(formatDateKey(dt));
    });
    monthlyHeaderSpan.colSpan=dateKeys.length;

    const promises=dateKeys.map(k=>db.ref('kehadiran/'+k).once('value'));
    Promise.all(promises).then(snaps=>{
      const allByDate={};
      snaps.forEach((snap,i)=>{allByDate[dateKeys[i]]=snap.val()||{};});

      monthlyTableBody.innerHTML='';
      let bil=1;

      summaryConfig.forEach(cfg=>{
        const tr=document.createElement('tr');
        const c1=document.createElement('td');c1.className='main-row-cell';c1.textContent=bil++;
        const c2=document.createElement('td');c2.className='main-row-cell darjah-col';c2.textContent=cfg.darjah;
        const c3=document.createElement('td');c3.className='main-row-cell';c3.textContent=cfg.kelasLabel;
        tr.appendChild(c1);tr.appendChild(c2);tr.appendChild(c3);

        const detailRow=document.createElement('tr');
        detailRow.className='absent-row';
        detailRow.style.display='none';
        const detailTd=document.createElement('td');
        detailTd.colSpan=3+dateKeys.length;
        detailRow.appendChild(detailTd);

        dateKeys.forEach(k=>{
          const rec=(allByDate[k]||{})[cfg.code];
          const td=document.createElement('td');td.className='main-row-cell';
          if(rec){
            const ratio=(rec.present||0)+"/"+(rec.total||0);
            if(rec.absentCount>0 && Array.isArray(rec.absentNames) && rec.absentNames.length){
              const link=document.createElement('span');
              link.className='attendance-link';
              link.textContent=ratio;
              link.addEventListener('click',()=>{
                const human=formatHumanDate(dateFromKey(k));
                const html="Tarikh "+human+"<br>Tidak hadir:<br>"+rec.absentNames.join("<br>");
                if(detailRow.style.display==='table-row' && detailRow.dataset.currentDate===k){
                  detailRow.style.display='none';
                }else{
                  detailRow.dataset.currentDate=k;
                  detailTd.innerHTML=html;
                  detailRow.style.display='table-row';
                }
              });
              td.appendChild(link);
            }else{
              td.textContent=ratio;
            }
          }else{
            td.textContent='-';
            td.style.color='#9ca3af';
          }
          tr.appendChild(td);
        });

        monthlyTableBody.appendChild(tr);
        monthlyTableBody.appendChild(detailRow);
      });

      monthlyInfo.textContent='Ringkasan untuk '+monthlyLabel.textContent+'. "-" bermaksud tiada rekod kehadiran pada hari tersebut.';
    }).catch(err=>{
      console.error(err);
      monthlyInfo.textContent='Ralat memuatkan data bulanan: '+err.message;
    });
  }

  // Event buttons
  classSelect.addEventListener('change',()=>{
    const kelas=classSelect.value;
    if(!kelas){studentsSection.style.display='none';summaryBox.style.display='none';clearStatus();return;}
    renderStudentsForClass(kelas);
    loadExistingAttendance(kelas);
  });

  btnSave.addEventListener('click',saveAttendance);

  btnAllPresent.addEventListener('click',()=>{
    studentsList.querySelectorAll('input[type=checkbox]').forEach(chk=>chk.checked=false);
    setStatus('Semua hadir (tiada murid ditanda tidak hadir).','info');
    summaryBox.style.display='none';
  });

  btnClearTicks.addEventListener('click',()=>{
    studentsList.querySelectorAll('input[type=checkbox]').forEach(chk=>chk.checked=false);
    setStatus('Tanda tidak hadir telah dikosongkan.','info');
    summaryBox.style.display='none';
  });

  // INIT
  populateClassDropdown();
  loadDailySummary();
  loadWeeklySummary();
  loadMonthlySummary();
})();
</script>
</body>
</html>
